<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–≠—Ç–∞–ª–æ–Ω ‚Äî —Ä–µ—Ñ–µ—Ä–µ–Ω—Å ¬´–î–æ—Ä–æ–∂–Ω—ã–µ –∫–∞—Ä—Ç—ã¬ª (–¢–∞–±–ª–∏—Ü–∞ / Kanban / –ì–∞–Ω—Ç)</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --panel:#ffffff;
      --panel2:#f8fafc;
      --fg:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 1px 2px rgba(0,0,0,.06), 0 10px 25px rgba(0,0,0,.08);
      --radius:12px;
      --radius2:10px;

      --red:#c62828;
      --redSoft:#f8d7da;

      --green:#2e7d32;
      --greenSoft:#dff2e1;

      --blue:#0d47a1;
      --blueSoft:#dbeafe;

      --grayCol:#f3f4f6;

      --chipBg:#eef2ff;
      --chipFg:#1f2937;

      --btn:#2563eb;
      --btnFg:#fff;
      --btnGhost:#f3f4f6;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--fg); background:var(--bg);
    }

    /* Top bar (approx Etalon header area) */
    .topbar{
      height:54px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      position:sticky; top:0; z-index:20;
    }
    .brand{
      display:flex; align-items:center; gap:10px; min-width:260px;
    }
    .logo{
      width:28px; height:28px; border-radius:8px;
      background:linear-gradient(135deg,#2563eb,#60a5fa);
      box-shadow:0 4px 12px rgba(37,99,235,.25);
    }
    .brandTitle{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brandTitle strong{font-size:13px}
    .brandTitle span{font-size:11px; color:var(--muted)}
    .topActions{
      display:flex; align-items:center; gap:10px;
    }
    .search{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--border); border-radius:999px;
      background:#fff; min-width:320px;
    }
    .search input{
      border:none; outline:none; width:100%; font-size:13px;
    }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--border); background:var(--panel2);
      padding:6px 10px; border-radius:999px;
      display:inline-flex; gap:8px; align-items:center;
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:calc(100vh - 54px);
    }
    @media (max-width: 1100px){
      .layout{grid-template-columns:1fr}
      .sidebar{display:none}
      .search{min-width:200px}
    }

    /* Sidebar (keep minimal, not full Etalon left menu) */
    .sidebar{
      background:var(--panel);
      border-right:1px solid var(--border);
      padding:12px;
    }
    .sideBlock{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    .sideBlock h3{
      margin:0; font-size:12px; padding:10px 10px;
      border-bottom:1px solid var(--border);
      background:var(--panel2);
      display:flex; align-items:center; justify-content:space-between;
    }
    .sideBlock .body{padding:10px}
    .field{margin-bottom:10px}
    label{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
    input[type="text"], input[type="date"], select, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:9px 10px;
      font-size:13px;
      background:#fff;
      outline:none;
    }
    textarea{min-height:70px; resize:vertical}
    input:focus, select:focus, textarea:focus{border-color:rgba(37,99,235,.55); box-shadow:0 0 0 3px rgba(37,99,235,.12);}

    .btnRow{display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      appearance:none; border:1px solid var(--border);
      background:var(--btnGhost);
      padding:9px 10px; border-radius:10px;
      font-size:13px; cursor:pointer;
      display:inline-flex; gap:8px; align-items:center;
    }
    .btn.primary{
      background:var(--btn); border-color:var(--btn); color:var(--btnFg);
    }
    .btn.small{padding:7px 9px; font-size:12px; border-radius:9px}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Main */
    .main{
      padding:12px;
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#fff 0%, #fbfbff 100%);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .panelHeadLeft{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .panelTitle{
      font-weight:800; font-size:14px;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--border);
      background:var(--panel2);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px; cursor:pointer;
    }
    .tab.active{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.35);
      color:#0b2a8a;
      font-weight:800;
    }

    /* Table */
    .tableWrap{overflow:auto}
    table{
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      min-width:1400px;
      background:#fff;
    }
    thead th{
      position:sticky; top:0;
      background:var(--panel2);
      border-bottom:1px solid var(--border);
      font-size:12px;
      text-align:left;
      padding:10px 10px;
      white-space:nowrap;
      color:#374151;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:9px 10px;
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover td{background:#fbfdff}
    .rowActions{display:flex; gap:8px}
    .linkBtn{
      border:none; background:transparent; color:#2563eb; cursor:pointer;
      font-size:13px; padding:0;
    }
    .sectionRow td{
      background:linear-gradient(180deg,#f8fafc 0%, #f1f5f9 100%);
      font-weight:900;
      color:#0f172a;
    }

    /* Kanban (Etalon-like columns, soft tint) */
    .kanban{
      padding:12px;
    }
    .kbTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .kbTop .left{display:flex; gap:10px; align-items:end; flex-wrap:wrap}
    .kbTop .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .kbBoard{display:flex; flex-direction:column; gap:14px;}
    .kbRow{display:grid; grid-template-columns: 240px 1fr; gap:12px; align-items:start;}
    .kbRowHead{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:12px;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:100%;
    }
    .kbRowTitle{font-weight:900; font-size:14px;}
    .kbRowMeta{font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .kbRowCols{
      display:grid;
      grid-template-columns: repeat(4, minmax(260px, 1fr));
      gap:12px;
      align-items:start;
    }
    @media (max-width: 1300px){
      .kbRow{grid-template-columns: 1fr;}
      .kbRowCols{grid-template-columns: repeat(2, minmax(240px, 1fr));}
    }
    @media (max-width: 800px){
      .kbRowCols{grid-template-columns: 1fr;}
    }

    .kbCol{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
      background:#fff;
    }
    .kbColHead{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900; font-size:13px;
    }
    .kbColHead .count{font-weight:800; color:var(--muted)}
    .kbColBody{
      padding:10px;
      min-height:220px;
      background:var(--grayCol);
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
    }
    .kbCol.red .kbColHead{background:var(--red); color:#fff}
    .kbCol.red .kbColBody{background:var(--redSoft)}
    .kbCol.green .kbColHead{background:var(--green); color:#fff}
    .kbCol.green .kbColBody{background:var(--greenSoft)}
    .kbCol.blue .kbColHead{background:var(--blue); color:#fff}
    .kbCol.blue .kbColBody{background:var(--blueSoft)}
    .kbCol.gray .kbColHead{background:#374151; color:#fff}
    .kbCol.gray .kbColBody{background:#eceff3}

    .kbCard{
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      padding:10px;
      cursor:grab;
      box-shadow:0 1px 1px rgba(0,0,0,.04);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kbCard:active{cursor:grabbing}
    .kbNumber{font-size:11px; font-weight:800; color:var(--muted); letter-spacing:0.2px; text-transform:uppercase;}
    .kbTitle{font-weight:900; font-size:13px; margin:0 0 4px 0; line-height:1.25}
    .kbSectionLine{font-size:11px; font-weight:800; color:var(--muted);}
    .kbRole{font-size:11px; font-weight:800; color:#1e3a8a;}
    .kbLine{padding:6px 8px; border-radius:10px; font-size:12px; font-weight:700;}
    .kbLine.owner{background:var(--greenSoft); color:var(--green);}
    .kbLine.co{background:#e5e7eb; color:#374151; font-weight:600;}
    .kbMeta{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--chipBg);
      color:var(--chipFg);
      font-size:12px;
      white-space:nowrap;
    }
    .chip.muted{background:#f3f4f6; color:#374151}
    .chip.bad{background:rgba(220,38,38,.10); border-color:rgba(220,38,38,.25); color:#7f1d1d}
    .chip.ok{background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.25); color:#065f46}

    .dropHint{
      border:2px dashed rgba(37,99,235,.35);
      border-radius:12px;
      padding:10px;
      background:rgba(37,99,235,.06);
      color:#0b2a8a;
      font-size:12px;
      min-height:44px;
      display:block;
      visibility:hidden;
      position:absolute;
      inset:10px;
      pointer-events:none;
      opacity:0;
      transition:opacity .1s ease;
      z-index:2;
    }
    .kbColBody.dragOver .dropHint{visibility:visible; opacity:1}

    /* Gantt */
    .gantt{
      padding:12px;
    }
    .gTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .gGrid{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:auto;
      background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .gInner{
      min-width:1200px;
      display:grid;
      grid-template-columns: 420px 1fr;
    }
    .gHeadL,.gHeadR{
      position:sticky; top:0; z-index:3;
      background:var(--panel2);
      border-bottom:1px solid var(--border);
      padding:10px;
      font-weight:900; font-size:12px;
    }
    .gHeadL{left:0; position:sticky}
    .gLeft{
      position:sticky; left:0; z-index:2;
      background:#fff;
      border-right:1px solid var(--border);
    }
    .gRowL{
      padding:10px;
      border-bottom:1px solid var(--border);
    }
    .gName{font-weight:900; font-size:13px; margin-bottom:4px}
    .gSub{font-size:12px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap}
    .gRowR{
      border-bottom:1px solid var(--border);
      padding:10px;
    }
    .months{
      display:grid;
      grid-template-columns: repeat(12, minmax(56px, 1fr));
      gap:6px;
      align-items:center;
    }
    .mCell{
      text-align:center;
      padding:6px 0;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size:11px;
      color:#374151;
    }
    .barWrap{
      position:relative;
      height:36px;
      border:1px solid var(--border);
      border-radius:12px;
      background:linear-gradient(180deg,#fff 0%, #fbfbff 100%);
      overflow:hidden;
    }
    .bar{
      position:absolute;
      top:6px;
      height:24px;
      border-radius:10px;
      padding:0 10px;
      display:flex;
      align-items:center;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border:1px solid rgba(37,99,235,.35);
      background:rgba(37,99,235,.15);
      color:#0b2a8a;
    }
    .bar.done{border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.16); color:#065f46}
    .bar.work{border-color:rgba(217,119,6,.35); background:rgba(217,119,6,.16); color:#92400e}
    .bar.over{border-color:rgba(220,38,38,.35); background:rgba(220,38,38,.14); color:#7f1d1d}

    /* Modal (Etalon-like) */
    .modal{
      position:fixed; inset:0;
      background:rgba(17,24,39,.35);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:50;
      overflow-y:auto;
    }
    .modal.active{display:flex}
    .modalPanel{
      width:min(980px, 100%);
      background:#fff;
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 16px 40px rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      max-height:90vh;
    }
    #itemModal .modalPanel, #modal .modalPanel{
      max-height:calc(100vh - 32px);
    }
    .modalHead{
      padding:10px 12px;
      background:var(--panel2);
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHeadLeft{
      display:flex; align-items:center; gap:10px;
    }
    .modalIcon{
      width:30px; height:30px; border-radius:10px;
      background:#e0e7ff;
      border:1px solid #c7d2fe;
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:#1e3a8a;
    }
    .modalTitle{
      display:flex; flex-direction:column; line-height:1.15;
    }
    .modalTitle strong{font-size:13px}
    .modalTitle span{font-size:11px; color:var(--muted)}
    .modalClose{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:7px 9px;
      cursor:pointer;
      font-size:13px;
    }
    .modalBody{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:12px;
      padding:12px;
      background:#fff;
      overflow-y:auto;
      flex:1;
      min-height:0;
    }
    @media (max-width: 1000px){
      .modalBody{grid-template-columns:1fr}
    }
    .modalSide, .modalMain{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .modalSide h4, .modalMain h4{
      margin:0;
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      background:var(--panel2);
      font-size:12px;
      font-weight:900;
      display:flex; align-items:center; justify-content:space-between;
    }
    .modalSide .content, .modalMain .content{padding:10px}
    .kv{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .kv .line{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      align-items:center;
      font-size:12px;
    }
    .kv .line.execsLine{
      grid-template-columns: 1fr;
      align-items:flex-start;
    }
    .kv .line.execsLine .k{
      margin-bottom:6px;
    }
    .kv .line .k{color:var(--muted)}
    .kv .line .v{font-weight:700; color:#111827}
    .modalFooter{
      padding:10px 12px;
      border-top:1px solid var(--border);
      background:var(--panel2);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      position:sticky;
      bottom:0;
      z-index:2;
    }
    .danger{
      background:rgba(220,38,38,.10);
      border-color:rgba(220,38,38,.25);
      color:#7f1d1d;
    }

    .disabledBlock{
      opacity:0.45;
    }

    .note{
      font-size:12px; color:var(--muted); line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="brandTitle">
        <strong>–≠–¢–ê–õ–û–ù</strong>
        <span>–†–µ—Ñ–µ—Ä–µ–Ω—Å –º–æ–¥—É–ª—è ¬´–î–æ—Ä–æ–∂–Ω—ã–µ –∫–∞—Ä—Ç—ã¬ª</span>
      </div>
    </div>
    <div class="topActions">
      <div class="search" title="–ü–æ–∏—Å–∫ –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º">
        <span style="font-size:12px;color:var(--muted)">–ü–æ–∏—Å–∫</span>
        <input id="globalSearch" placeholder="–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / —Ä–µ–∑—É–ª—å—Ç–∞—Ç / –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ / –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" />
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="sideBlock">
        <div class="body">
          <div class="field">
            <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –¥–æ—Ä–æ–∂–Ω–æ–π –∫–∞—Ä—Ç—ã</label>
            <input type="text" id="dkName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–ö —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏ (2026)" />
          </div>
          <div class="field">
            <label>–ü–µ—Ä–∏–æ–¥: –Ω–∞—á–∞–ª–æ</label>
            <input type="date" id="dkPeriodStart" />
          </div>

          <div class="field">
            <label>–ü–µ—Ä–∏–æ–¥: –∫–æ–Ω–µ—Ü</label>
            <input type="date" id="dkPeriodEnd" />
          </div>

          <div class="field">
            <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –î–ö</label>
            <input type="text" id="dkOwner" placeholder="–ú–∏–Ω—Ç—Ä—É–¥ / –≤–µ–¥–æ–º—Å—Ç–≤–æ" />
          </div>

          <div class="field">
            <label>–ß–µ–º —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –î–ö</label>
            <input type="text" id="dkApprovedBy" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ..." />
          </div>

          <div class="field">
            <label>–ù–æ–º–µ—Ä / –¥–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
            <input type="text" id="dkApprovedDoc" placeholder="‚Ññ –∏ –¥–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞" />
          </div>

          <div class="field">
            <label>–§–∏–ª—å—Ç—Ä: —Å—Ç–∞—Ç—É—Å</label>
            <select id="fStatus">
              <option value="">–í—Å–µ</option>
              <option value="planned">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
              <option value="work">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="done">–ò—Å–ø–æ–ª–Ω–µ–Ω–æ</option>
              <option value="canceled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
            </select>
          </div>

          <div class="field">
            <label>–§–∏–ª—å—Ç—Ä: —Ä–∞–∑–¥–µ–ª</label>
            <select id="fSection"></select>
          </div>

          <div class="field">
            <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
            <select id="fExec"></select>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="btnAddItem">+ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
            <button class="btn" id="btnAddSection">+ –†–∞–∑–¥–µ–ª</button>
          </div>

          <div style="height:10px"></div>

          <div class="btnRow">
            <button class="btn small" id="btnDemo">–î–µ–º–æ</button>
            <button class="btn small" id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="btn small" id="btnImport">–ò–º–ø–æ—Ä—Ç</button>
            <button class="btn small danger" id="btnClear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div style="height:10px"></div>
          <div class="note" id="kpi"></div>
        </div>
      </div>
    </aside>

    <main class="main">
      <section class="panel">
        <div class="panelHead">
          <div class="panelHeadLeft">
            <div class="panelTitle" id="panelTitle">–¢–∞–±–ª–∏—Ü–∞</div>
          </div>
          <div class="tabs">
            <button class="tab active" data-tab="table">–¢–∞–±–ª–∏—Ü–∞</button>
            <button class="tab" data-tab="kanban">–î–æ—Å–∫–∏</button>
            <button class="tab" data-tab="gantt">–ì–∞–Ω—Ç</button>
          </div>
        </div>

        <!-- Views -->
        <div id="viewTable" class="view">
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:80px">‚Ññ</th>
                  <th style="width:260px">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th>
                  <th style="width:130px">–ü–ª–∞–Ω: –Ω–∞—á–∞–ª–æ</th>
                  <th style="width:130px">–ü–ª–∞–Ω: –∫–æ–Ω–µ—Ü</th>
                  <th style="width:170px">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                  <th style="width:220px">–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</th>
                  <th style="width:220px">–¶–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                  <th style="width:120px">–°—Ç–∞—Ç—É—Å</th>
                  <th style="width:220px">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                  <th style="width:120px">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div id="viewKanban" class="view" style="display:none">
          <div class="kanban">
            <div class="kbTop">
              <div class="left">
                <div class="field" style="margin:0; min-width:220px">
                  <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞</label>
                  <select id="kbGroupBy">
                    <option value="none">–ë–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏</option>
                    <option value="section">–ü–æ —Ä–∞–∑–¥–µ–ª–∞–º</option>
                    <option value="executor">–ü–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º</option>
                  </select>
                </div>
                <div class="field" style="margin:0; min-width:220px">
                  <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</label>
                  <select id="kbShowCanceled">
                    <option value="yes" selected>–î–∞</option>
                    <option value="no">–ù–µ—Ç</option>
                  </select>
                  </div>
              </div>
              <div class="right">
                <button class="btn primary" id="kbPlus">+ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
              </div>
            </div>

            <div class="kbBoard" id="kbBoard"></div>
          </div>
        </div>

        <div id="viewGantt" class="view" style="display:none">
          <div class="gantt">
            <div class="gTop">
              <div class="left" style="display:flex; gap:10px; flex-wrap:wrap">
                <div class="field" style="margin:0; min-width:220px">
                  <label>–ü–æ–ª–æ—Å–∞ –ø–æ</label>
                  <select id="gMode">
                    <option value="plan">–ü–ª–∞–Ω–æ–≤—ã–º –¥–∞—Ç–∞–º</option>
                    <option value="fact">–§–∞–∫—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –ø–ª–∞–Ω)</option>
                  </select>
                </div>
                <div class="field" style="margin:0; min-width:220px">
                  <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ</label>
                  <select id="gShowCanceled">
                    <option value="no">–ù–µ—Ç</option>
                    <option value="yes">–î–∞</option>
                  </select>
                </div>
              </div>
              <div class="right">
                <button class="btn primary" id="gPlus">+ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>
              </div>
            </div>

            <div class="gGrid">
              <div class="gInner" id="gInner"></div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modalPanel">
      <div class="modalHead">
        <div class="modalHeadLeft">
          <div class="modalIcon">‚â°</div>
          <div class="modalTitle">
            <strong id="mTitle">–ö–∞—Ä—Ç–æ—á–∫–∞</strong>
            <span id="mSub">‚Äî</span>
          </div>
        </div>
        <button class="modalClose" id="mClose">‚ùå</button>
      </div>

      <div class="modalBody">
        <div class="modalSide">
          <h4>
            <span>–ü–æ–ª—è</span>
            <span class="pill" id="mId">‚Äî</span>
          </h4>
          <div class="content">
            <div class="field">
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select id="mStatus">
                <option value="planned">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
                <option value="work">–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done">–ò—Å–ø–æ–ª–Ω–µ–Ω–æ</option>
                <option value="canceled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
              </select>
            </div>

            <div class="field">
              <label>–†–∞–∑–¥–µ–ª</label>
              <select id="mSection"></select>
            </div>

            <div class="field">
              <label>–ü–ª–∞–Ω: –Ω–∞—á–∞–ª–æ</label>
              <input type="date" id="mPlanStart" />
            </div>

            <div class="field">
              <label>–ü–ª–∞–Ω: –∫–æ–Ω–µ—Ü</label>
              <input type="date" id="mPlanEnd" />
            </div>

            <div class="field">
              <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
              <input type="text" id="mOwner" placeholder="–§–ò–û / –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ" />
            </div>

            <div class="field">
              <label>–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ (—á–µ—Ä–µ–∑ ; )</label>
              <input type="text" id="mCo" placeholder="–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ; –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ" />
            </div>

            <div class="field">
              <label>–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ, ‚ÇΩ</label>
              <input type="text" id="mMoney" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 10 000 000" />
            </div>

            <div class="field">
              <label>‚Ññ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (–µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∞–≤—Ç–æ–Ω—É–º–µ—Ä–∞—Ü–∏—è)</label>
              <input type="text" id="mNumber" placeholder="1.1" />
            </div>
          </div>
        </div>

        <div class="modalMain">
          <h4>
            <span>–û–ø–∏—Å–∞–Ω–∏–µ</span>
            <span class="pill">–≤–∫–ª–∞–¥–∫–∞</span>
          </h4>
          <div class="content">
            <div class="field">
              <label>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</label>
              <input type="text" id="mName" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" />
            </div>

            <div class="field">
              <label>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</label>
              <textarea id="mResult" placeholder="–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω–æ –ø–æ –∏—Ç–æ–≥—É"></textarea>
            </div>

            <div class="field">
              <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
              <textarea id="mNote" placeholder="–î–æ–ø. —É—Å–ª–æ–≤–∏—è / —Ä–∏—Å–∫–∏ / —Å—Å—ã–ª–∫–∏"></textarea>
            </div>

            <div class="field">
              <label>–¶–µ–ª–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å</label>
              <div class="kv" style="grid-template-columns: 1fr 1fr">
                <div class="line" style="display:block">
                  <div class="k" style="margin-bottom:6px">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</div>
                  <input type="text" id="mKpiName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥" />
                </div>
                <div class="line" style="display:block">
                  <div class="k" style="margin-bottom:6px">–ï–¥. –∏–∑–º–µ—Ä–µ–Ω–∏—è</div>
                  <input type="text" id="mKpiUnit" placeholder="—à—Ç. / % / –µ–¥." />
                </div>
              </div>
            </div>

            <div class="field">
              <label>–¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –¥–∞—Ç–∞–º / –ø–µ—Ä–∏–æ–¥–∞–º</label>
              <div class="btnRow" style="margin-bottom:8px; justify-content:space-between; gap:8px">
                <button class="btn small primary" type="button" id="kpiAddTarget">+ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</button>
                <button class="btn small" type="button" id="kpiToggleTargets" style="display:none">–°–≤–µ—Ä–Ω—É—Ç—å</button>
              </div>
              <div id="kpiTargetsList" class="note"></div>
              <div id="kpiTargetForm" style="margin-top:8px; display:none; border:1px solid var(--border); padding:10px; border-radius:10px; background:var(--panel2)">
                <div class="kv" style="grid-template-columns: 1fr 1fr; align-items:end; gap:14px">
                  <div class="line" style="display:block">
                    <div class="k" style="margin-bottom:6px; font-weight:700; color:var(--fg)">–ü–ª–∞–Ω</div>
                    <div class="field" style="margin-bottom:8px">
                      <label>–î–∞—Ç–∞ –ø–ª–∞–Ω–∞</label>
                      <input type="date" id="kpiTargetPlanDate" />
                    </div>
                    <div class="field" style="margin-bottom:8px">
                      <label>–ü–ª–∞–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                      <input type="text" id="kpiTargetPlanValue" placeholder="–ß–∏—Å–ª–æ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ" />
                    </div>
                  </div>
                  <div class="line" style="display:block">
                    <div class="k" style="margin-bottom:6px; font-weight:700; color:var(--fg)">–§–∞–∫—Ç</div>
                    <div class="field" style="margin-bottom:8px">
                      <label>–î–∞—Ç–∞ —Ñ–∞–∫—Ç–∞</label>
                      <input type="date" id="kpiTargetFactDate" />
                    </div>
                    <div class="field" style="margin-bottom:8px">
                      <label>–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
                      <input type="text" id="kpiTargetFactValue" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 80%" />
                    </div>
                  </div>
                </div>
                <div class="btnRow" style="justify-content:flex-end">
                  <button class="btn" type="button" id="kpiTargetCancel">–û—Ç–º–µ–Ω–∞</button>
                  <button class="btn primary small" type="button" id="kpiTargetSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </div>

            <div class="field">
              <label>–û—Ç—á–µ—Ç—ã</label>
              <div class="btnRow" style="margin-bottom:8px; justify-content:space-between; gap:8px">
                <button class="btn small primary" type="button" id="addReportBtn">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –æ—Ç—á–µ—Ç</button>
                <button class="btn small" type="button" id="reportsToggle" style="display:none">–°–≤–µ—Ä–Ω—É—Ç—å</button>
              </div>
              <div id="reportsList" class="note"></div>
              <div id="reportForm" style="margin-top:10px; display:none; border:1px solid var(--border); padding:10px; border-radius:10px; background:var(--panel2)">
                <div class="field" style="margin-bottom:8px">
                  <label>–î–∞—Ç–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞</label>
                  <input type="date" id="reportDate" />
                </div>
                <div class="field" style="margin-bottom:8px">
                  <label>–û—Ç—á–µ—Ç</label>
                  <textarea id="reportText" placeholder="–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ"></textarea>
                </div>
                <div class="btnRow">
                  <button class="btn primary small" type="button" id="reportSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç—á–µ—Ç</button>
                  <button class="btn small" type="button" id="reportCancel">–û—Ç–º–µ–Ω–∞</button>
                </div>
              </div>

              <div id="finalReportBlock" style="margin-top:14px; border-top:1px solid var(--border); padding-top:10px">
                <div class="btnRow" style="margin-bottom:8px; justify-content:space-between; gap:8px">
                  <div style="font-weight:700">–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç</div>
                  <div class="btnRow">
                    <button class="btn small primary" type="button" id="finalReportEdit">–°–æ–∑–¥–∞—Ç—å / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn small danger" type="button" id="finalReportDelete">üóë</button>
                  </div>
                </div>
                <div id="finalReportView" class="note">‚Äî</div>
                <div id="finalReportForm" style="margin-top:8px; display:none; border:1px solid var(--border); padding:10px; border-radius:10px; background:var(--panel2)">
                  <div class="field" style="margin-bottom:8px">
                    <label>–î–∞—Ç–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞</label>
                    <input type="date" id="finalDate" />
                  </div>
                  <div class="field" style="margin-bottom:8px">
                    <label>–ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞</label>
                    <input type="text" id="finalPeriod" placeholder="Q3 2025 / 2024" />
                  </div>
                  <div class="field" style="margin-bottom:8px">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / —Ñ–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                    <textarea id="finalText" placeholder="–ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"></textarea>
                  </div>
                  <div class="btnRow">
                    <button class="btn primary small" type="button" id="finalSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç</button>
                    <button class="btn small" type="button" id="finalCancel">–û—Ç–º–µ–Ω–∞</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="kv">
              <div class="line"><div class="k">–°–æ–∑–¥–∞–Ω–æ:</div><div class="v" id="mCreated">‚Äî</div></div>
              <div class="line"><div class="k">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</div><div class="v" id="mUpdated">‚Äî</div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <div class="btnRow">
          <button class="btn danger" id="mDelete">üóë</button>
        </div>
        <div class="btnRow" style="margin-left:auto">
          <button class="btn" id="mCancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" id="mSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="sectionStatsModal">
    <div class="modalPanel" style="max-width:720px">
      <div class="modalHead">
        <div class="modalHeadLeft">
          <div class="modalIcon">Œ£</div>
          <div class="modalTitle">
            <strong id="secStatsTitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–∞</strong>
            <span id="secStatsSub">‚Äî</span>
          </div>
        </div>
        <button class="modalClose" id="secStatsClose">‚ùå</button>
      </div>
      <div class="modalBody" style="grid-template-columns: 1fr">
        <div class="modalMain">
          <div class="content">
            <div class="kv" style="grid-template-columns:1fr 1fr">
              <div class="line"><div class="k">–í—Å–µ–≥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div><div class="v" id="secStatsTotal">‚Äî</div></div>
              <div class="line"><div class="k">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å</div><div class="v" id="secStatsPlanned">‚Äî</div></div>
              <div class="line"><div class="k">–í —Ä–∞–±–æ—Ç–µ</div><div class="v" id="secStatsWork">‚Äî</div></div>
              <div class="line"><div class="k">–ì–æ—Ç–æ–≤–æ</div><div class="v" id="secStatsDone">‚Äî</div></div>
              <div class="line"><div class="k">–û—Ç–º–µ–Ω–µ–Ω–æ</div><div class="v" id="secStatsCanceled">‚Äî</div></div>
              <div class="line"><div class="k">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–∑–¥–µ–ª–∞</div><div class="v" id="secStatsStart">‚Äî</div></div>
              <div class="line"><div class="k">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞</div><div class="v" id="secStatsEnd">‚Äî</div></div>
              <div class="line"><div class="k">–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ, ‚ÇΩ</div><div class="v" id="secStatsMoney">‚Äî</div></div>
            </div>

            <div style="height:10px"></div>

            <div class="kv">
              <div class="line execsLine">
                <div class="k">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</div>
                <div class="v" id="secStatsExecs" style="display:flex; gap:6px; flex-wrap:wrap"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="sectionEditModal">
    <div class="modalPanel" style="max-width:520px">
      <div class="modalHead">
        <div class="modalHeadLeft">
          <div class="modalIcon">‚öô</div>
          <div class="modalTitle">
            <strong id="secEditTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</strong>
            <span id="secEditSub">‚Äî</span>
          </div>
        </div>
        <button class="modalClose" id="secEditClose">‚ùå</button>
      </div>
      <div class="modalBody" style="grid-template-columns:1fr">
        <div class="modalMain">
          <h4>
            <span>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–∑–¥–µ–ª–∞</span>
          </h4>
          <div class="content">
            <div class="field">
              <label>–ù–æ–º–µ—Ä / –∫–æ–¥ —Ä–∞–∑–¥–µ–ª–∞</label>
              <input type="text" id="secEditNumber" />
            </div>
            <div class="field">
              <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</label>
              <input type="text" id="secEditName" />
            </div>
            <div class="field">
              <label>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</label>
              <div class="btnRow">
                <button class="btn small" type="button" id="secMoveUp">‚Üë –í–≤–µ—Ä—Ö</button>
                <button class="btn small" type="button" id="secMoveDown">‚Üì –í–Ω–∏–∑</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <div class="btnRow">
          <button class="btn danger" id="secEditDelete">üóë –†–∞–∑–¥–µ–ª</button>
        </div>
        <div class="btnRow" style="margin-left:auto">
          <button class="btn" id="secEditCancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" id="secEditSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />

  <script>
    /* =========================
       Storage & data model
    ========================= */
    const STORAGE_KEY = "etalon_roadmaps_working_v1";
    const Status = {
      planned: {label:"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ", col:"red"},
      work: {label:"–í —Ä–∞–±–æ—Ç–µ", col:"green"},
      done: {label:"–ì–æ—Ç–æ–≤–æ", col:"blue"},
      canceled: {label:"–û—Ç–º–µ–Ω–µ–Ω–æ", col:"gray"}
    };
    const Columns = [
      {key:"planned", label:"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å", style:"red"},
      {key:"work", label:"–í —Ä–∞–±–æ—Ç–µ", style:"green"},
      {key:"done", label:"–ì–æ—Ç–æ–≤–æ", style:"blue"},
      {key:"canceled", label:"–û—Ç–º–µ–Ω–µ–Ω–æ", style:"gray"}
    ];

    function uid(prefix="id"){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function nowISO(){
      const d = new Date();
      return d.toISOString().slice(0,19).replace("T"," ");
    }
    function todayDate(){
      return new Date().toISOString().slice(0,10);
    }
    function setDefaultDate(input){
      if(input && !input.value){
        input.value = todayDate();
      }
    }
    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        console.error(e);
        return null;
      }
    }
    function demo(){
      const sec1 = uid("sec"), sec2 = uid("sec");
      return {
        dk: { name:"–î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ (–ø—Ä–∏–º–µ—Ä)", year:String(new Date().getFullYear()), periodStart: dateOf(1), periodEnd: dateOf(12), owner:"–ú–∏–Ω—Ç—Ä—É–¥", approvedBy:"–ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞", approvedDoc:"‚Ññ123 –æ—Ç 01.01." },
        sections: [
          {id: sec1, name:"–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è", number:"1", order:1, createdAt: nowISO()},
          {id: sec2, name:"–†–µ–∞–ª–∏–∑–∞—Ü–∏—è", number:"2", order:2, createdAt: nowISO()},
        ],
        items: [
          {
            id: uid("it"),
            name:"–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏—è –æ–± —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –î–ö",
            sectionId: sec1,
            number:"1.1",
            status:"work",
            planStart: dateOf(1),
            planEnd: dateOf(2),
            owner:"–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
            co:"–Æ—Ä.–æ—Ç–¥–µ–ª; –ê–ø–ø–∞—Ä–∞—Ç",
            money:"0",
            result:"–ü—Ä–æ–µ–∫—Ç –ù–ü–ê –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω",
            note:"–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –≤ 3 –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è—Ö",
            reports:[{id:uid("rep"), date:dateOf(2), period:"—è–Ω–≤–∞—Ä—å", text:"–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –ø—Ä–æ–µ–∫—Ç"}],
            finalReport:null,
            kpi:{name:"–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞", unit:"—à—Ç.", plan:"1"},
            createdAt: nowISO(),
            updatedAt: nowISO()
          },
          {
            id: uid("it"),
            name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—á–µ–Ω—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∏ –æ–∂–∏–¥–∞–µ–º—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
            sectionId: sec1,
            number:"1.2",
            status:"planned",
            planStart: dateOf(3),
            planEnd: dateOf(4),
            owner:"–ü–µ—Ç—Ä–æ–≤ –ü.–ü.",
            co:"–ü—Ä–æ–µ–∫—Ç–Ω—ã–π –æ—Ñ–∏—Å",
            money:"‚Äî",
            result:"–†–µ–µ—Å—Ç—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π —É—Ç–≤–µ—Ä–∂–¥—ë–Ω",
            note:"",
            reports:[],
            finalReport:null,
            kpi:{name:"–†–µ–µ—Å—Ç—Ä", unit:"—à—Ç.", plan:"1"},
            createdAt: nowISO(),
            updatedAt: nowISO()
          },
          {
            id: uid("it"),
            name:"–ü–∏–ª–æ—Ç: –∑–∞–≤–µ—Å—Ç–∏ –î–ö –≤ —Å–∏—Å—Ç–µ–º–µ –∏ –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª",
            sectionId: sec2,
            number:"2.1",
            status:"planned",
            planStart: dateOf(6),
            planEnd: dateOf(9),
            owner:"–ö—É—Ä–∞—Ç–æ—Ä –î–ö",
            co:"–ò–¢; –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è",
            money:"‚Äî",
            result:"–ü–∏–ª–æ—Ç –ø—Ä–æ–≤–µ–¥—ë–Ω, –ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ —Ç–∏—Ä–∞–∂–∏—Ä–æ–≤–∞–Ω–∏–∏",
            note:"",
            createdAt: nowISO(),
            updatedAt: nowISO()
          },
          {
            id: uid("it"),
            name:"–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç –æ —Å—Ç–∞—Ç—É—Å–µ –î–ö –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞",
            sectionId: sec2,
            number:"2.2",
            status:"done",
            planStart: dateOf(10),
            planEnd: dateOf(10),
            owner:"–ê–Ω–∞–ª–∏—Ç–∏–∫",
            co:"–ö—É—Ä–∞—Ç–æ—Ä –î–ö",
            money:"0",
            result:"–û—Ç—á—ë—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω",
            note:"",
            createdAt: nowISO(),
            updatedAt: nowISO()
          }
        ]
      };
    }
    function dateOf(month){
      const y = new Date().getFullYear();
      const m = Math.min(12, Math.max(1, month));
      const dt = new Date(Date.UTC(y, m-1, 1));
      return dt.toISOString().slice(0,10);
    }

    let state = load() || demo();
    function normalizeReport(rep){
      if(!rep) return null;
      return {
        id: rep.id || uid("rep"),
        date: rep.date || "",
        period: rep.period || "",
        text: rep.text || ""
      };
    }
    function normalizeKpiTarget(t){
      if(!t) return {id: uid("kpit"), planDate:"", planValue:"", factDate:"", factValue:""};
      return {
        id: t.id || uid("kpit"),
        planDate: t.planDate || t.period || "",
        planValue: t.planValue ?? t.value ?? "",
        factDate: t.factDate || "",
        factValue: t.factValue || ""
      };
    }
    function ensureDefaults(){
      state.dk = state.dk || {};
      state.dk.periodStart = state.dk.periodStart || "";
      state.dk.periodEnd = state.dk.periodEnd || "";
      state.dk.owner = state.dk.owner || "";
      state.dk.approvedBy = state.dk.approvedBy || "";
      state.dk.approvedDoc = state.dk.approvedDoc || "";
      state.dk.year = state.dk.year || (state.dk.periodStart ? state.dk.periodStart.slice(0,4) : String(new Date().getFullYear()));
      state.sections = state.sections || [];
      state.items = state.items || [];
      state.sections.forEach((s,idx)=>{
        if(typeof s.order !== "number") s.order = idx+1;
        if(!s.number){
          const m = (s.name||"").match(/^(\d+)/);
          s.number = m ? m[1] : String(idx+1);
        }
      });
      normalizeSectionOrders();
      state.collapsedSections = state.collapsedSections || {};
      state.items.forEach(it=>{
        it.reports = Array.isArray(it.reports) ? it.reports.map(normalizeReport) : [];
        it.finalReport = it.finalReport ? normalizeReport(it.finalReport) : null;
        it.kpi = it.kpi || {name:"", unit:""};
        it.kpiTargets = Array.isArray(it.kpiTargets) ? it.kpiTargets.map(normalizeKpiTarget) : [];
      });
      const starts = state.items.map(it=>it.planStart).filter(Boolean).sort();
      const ends = state.items.map(it=>it.planEnd).filter(Boolean).sort();
      if(!state.dk.periodStart && starts.length) state.dk.periodStart = starts[0];
      if(!state.dk.periodEnd && ends.length) state.dk.periodEnd = ends[ends.length-1];
      if(!state.dk.periodStart) state.dk.periodStart = todayDate();
      if(!state.dk.periodEnd) state.dk.periodEnd = todayDate();
    }
    ensureDefaults();

    /* =========================
       UI state
    ========================= */
    let currentTab = "table";
    let editingId = null;
    let dragId = null;
    let dragGroup = null;
    let currentReports = [];
    let currentKpiTargets = [];
    let currentFinalReport = null;
    let editingReportId = null;
    let editingKpiTargetId = null;
    let kpiTargetsCollapsed = false;
    let reportsCollapsed = false;
    let editingSectionId = null;

    /* =========================
       Helpers
    ========================= */
    function esc(s){
      const str = String(s ?? "");
      return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function parseMoney(v){
      if(!v || v === "‚Äî") return 0;
      const num = parseFloat(String(v).replace(/[^0-9.,-]/g, '').replace(',', '.'));
      return isNaN(num) ? 0 : num;
    }
    function formatMoney(num){
      return new Intl.NumberFormat('ru-RU').format(num);
    }
    function formatMoneyWithCurrency(num){
      return `${formatMoney(num)} ‚ÇΩ`;
    }
    function moneyDisplay(value){
      const str = String(value ?? "").trim();
      if(!str) return "‚Äî";
      if(str === "‚Äî") return "‚Äî";
      if(!/[0-9]/.test(str)) return str;
      const num = parseMoney(str);
      return `${formatMoney(num)} ‚ÇΩ`;
    }
    function uniqueList(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    }
    function sectionDisplayName(sec){
      if(!sec) return "‚Äî";
      const num = sec.number ? `${sec.number}. ` : "";
      return `${num}${sec.name||""}`.trim();
    }
    function autoNumberForItem(sectionId, excludeId=null){
      const secs = sortedSections();
      const idx = secs.findIndex(s=>s.id===sectionId);
      const secNum = idx>=0 ? (secs[idx].number || String(idx+1)) : String(secs.length+1);
      const used = new Set(state.items.filter(x=>x.sectionId===sectionId && x.id!==excludeId).map(x=>x.number).filter(Boolean));
      let n = 1;
      while(used.has(`${secNum}.${n}`)) n++;
      return `${secNum}.${n}`;
    }
    function refreshItemNumbers(){
      sortedSections().forEach(sec=>{
        const prefix = sec.number || String(sec.order||"1");
        const inSec = state.items.filter(it=>it.sectionId===sec.id);
        inSec.forEach((it, idx)=>{
          const parts = (it.number||"").split(".");
          const suffix = parts.length>1 ? parts.slice(1).join(".") : String(idx+1);
          const safeSuffix = suffix || String(idx+1);
          it.number = `${prefix}.${safeSuffix}`;
        });
      });
    }
    function reportSummary(it){
      const cnt = (it.reports||[]).length;
      const hasFinal = !!it.finalReport;
      if(!cnt && !hasFinal) return "‚Äî";
      return `${cnt} —à—Ç.${hasFinal ? " + –∏—Ç–æ–≥" : ""}`;
    }
    function kpiName(it){
      const k = it.kpi || {};
      if(!k.name && !k.unit) return "‚Äî";
      return `${k.name||"‚Äî"}`;
    }
    function kpiPlan(it){
      const k = it.kpi || {};
      if(!k.name && !k.unit) return "‚Äî";
      const unit = k.unit ? ` ${k.unit}` : "";
      return `${k.name||"‚Äî"}${unit}`;
    }
    function kpiDisplay(it){
      const k = it.kpi || {};
      if(!k.name && !k.unit) return "‚Äî";
      const parts = [];
      if(k.name) parts.push(k.name);
      if(k.unit) parts.push(k.unit);
      return parts.join(" / ") || "‚Äî";
    }
    function sortedSections(){
      return [...state.sections].sort((a,b)=>(a.order||0)-(b.order||0) || (a.name||"").localeCompare(b.name||""));
    }
    function byId(list, id){ return list.find(x=>x.id===id); }

    function globalQuery(){
      return document.getElementById("globalSearch").value.trim().toLowerCase();
    }
    function filterStatus(){
      return document.getElementById("fStatus").value;
    }
    function filterSection(){
      return document.getElementById("fSection").value;
    }
    function filterExec(){
      return document.getElementById("fExec").value.trim();
    }

    function filteredItems(){
      const q = globalQuery();
      const fs = filterStatus();
      const fsec = filterSection();
      const fexec = filterExec();

      return state.items.filter(it=>{
        if(fs && it.status !== fs) return false;
        if(fsec && it.sectionId !== fsec) return false;
        if(fexec){
          const coList = (it.co||"").split(/[;,]/).map(x=>x.trim()).filter(Boolean);
          const ownerMatch = ((it.owner||"").trim()) === fexec;
          const coMatch = coList.includes(fexec);
          if(!ownerMatch && !coMatch) return false;
        }

        if(q){
          const blob = [it.name,it.result,it.note,it.owner,it.co,it.money,it.kpi?.name,it.kpi?.plan,it.kpi?.unit,(it.reports||[]).map(r=>r.text).join(" "), it.finalReport?.text].join(" ").toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });
    }

    function setDKMini(){
      const mini = `${state.dk.periodStart||"‚Äî"} ‚Üí ${state.dk.periodEnd||"‚Äî"}`;
      const dkMini = document.getElementById("dkMini");
      if(dkMini) dkMini.textContent = mini;
      document.getElementById("dkName").value = state.dk.name || "";
      const dkStartInput = document.getElementById("dkPeriodStart");
      const dkEndInput = document.getElementById("dkPeriodEnd");
      dkStartInput.value = state.dk.periodStart || "";
      dkEndInput.value = state.dk.periodEnd || "";
      setDefaultDate(dkStartInput);
      setDefaultDate(dkEndInput);
      document.getElementById("dkOwner").value = state.dk.owner || "";
      document.getElementById("dkApprovedBy").value = state.dk.approvedBy || "";
      document.getElementById("dkApprovedDoc").value = state.dk.approvedDoc || "";
    }

    function renderFilters(){
      const sel = document.getElementById("fSection");
      const current = sel.value;
      sel.innerHTML = "";
      const all = document.createElement("option");
      all.value = "";
      all.textContent = "–í—Å–µ";
      sel.appendChild(all);

      const secs = sortedSections();
      secs.forEach(s=>{
        const o = document.createElement("option");
        o.value = s.id;
        o.textContent = sectionDisplayName(s);
        sel.appendChild(o);
      });
      if([...sel.options].some(o=>o.value===current)) sel.value = current;
      else sel.value = "";

      // modal section select
      const ms = document.getElementById("mSection");
      const currM = ms.value;
      ms.innerHTML = "";
      secs.forEach(s=>{
        const o = document.createElement("option");
        o.value = s.id;
        o.textContent = sectionDisplayName(s);
        ms.appendChild(o);
      });
      if([...ms.options].some(o=>o.value===currM)) ms.value = currM;

      const execs = uniqueList([
        ...state.items.map(it=> (it.owner||"").trim()),
        ...state.items.flatMap(it=> (it.co||"").split(/[;,]/).map(x=>x.trim()))
      ].filter(Boolean));
      const fExec = document.getElementById("fExec");
      const fExecCurr = fExec.value;
      fExec.innerHTML = "<option value=''>–í—Å–µ</option>";
      execs.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        fExec.appendChild(opt);
      });
      if([...fExec.options].some(o=>o.value===fExecCurr)) fExec.value = fExecCurr;
    }

    function renderKPI(){
      const items = filteredItems();
      const total = items.length;
      const by = {planned:0, work:0, done:0, canceled:0};
      items.forEach(it=>{ by[it.status] = (by[it.status]||0)+1; });

      const starts = items.map(it=>it.planStart).filter(Boolean).sort();
      const ends = items.map(it=>it.planEnd).filter(Boolean).sort();
      const moneySum = items.reduce((m,it)=> m + parseMoney(it.money), 0);
      const startDk = starts[0] || "‚Äî";
      const endDk = ends[ends.length-1] || "‚Äî";

      document.getElementById("kpi").innerHTML =
        `–í—Å–µ–≥–æ: <b>${total}</b><br>`+
        `–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å: <b>${by.planned||0}</b><br>`+
        `–í —Ä–∞–±–æ—Ç–µ: <b>${by.work||0}</b><br>`+
        `–ì–æ—Ç–æ–≤–æ: <b>${by.done||0}</b><br>`+
        `–û—Ç–º–µ–Ω–µ–Ω–æ: <b>${by.canceled||0}</b><br>`+
        `–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –î–ö: <b>${startDk}</b><br>`+
        `–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –î–ö: <b>${endDk}</b><br>`+
        `–û–±—â–µ–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –î–ö: <b>${formatMoneyWithCurrency(moneySum)}</b>`;
    }

    /* =========================
       Table
    ========================= */
    function renderTable(){
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      const items = filteredItems();
      const secs = sortedSections();

      let rows = 0;
      secs.forEach(sec=>{
        const inSecAll = state.items.filter(x=>x.sectionId===sec.id);
        const inSec = items.filter(x=>x.sectionId===sec.id);
        const collapsed = !!state.collapsedSections[sec.id];

        const trS = document.createElement("tr");
        trS.className = "sectionRow";
        trS.innerHTML = `<td colspan="10">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <button class="btn small" type="button" data-action="add">‚ûï</button>
              <div>${esc(sectionDisplayName(sec))}</div>
            </div>
            <div class="rowActions">
              <button class="btn small" type="button" data-action="edit">‚úè</button>
              <button class="btn small danger" type="button" data-action="delete">üóë</button>
              <button class="btn small" type="button" data-action="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
              <button class="btn small" type="button" data-action="toggle">${collapsed?"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å":"–°–≤–µ—Ä–Ω—É—Ç—å"}</button>
            </div>
          </div>
        </td>`;
        tbody.appendChild(trS);

        trS.querySelectorAll("button").forEach(btn=>{
          btn.addEventListener("click",(e)=>{
            e.stopPropagation();
            const act = btn.dataset.action;
            if(act==="toggle"){
              state.collapsedSections[sec.id] = !collapsed;
              save();
              renderAll();
            } else if(act==="add"){
              openModal(null, {sectionId: sec.id});
            } else if(act==="edit"){
              openSectionEdit(sec);
            } else if(act==="delete"){
              if(inSecAll.length && !confirm("–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª –∏ –≤—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è?")) return;
              state.sections = state.sections.filter(s=>s.id!==sec.id);
              state.items = state.items.filter(it=>it.sectionId!==sec.id);
              delete state.collapsedSections[sec.id];
              normalizeSectionOrders();
              save();
              renderAll();
            } else if(act==="stats"){
              openSectionStats(sec);
            }
          });
        });

        if(collapsed) return;

        inSec.sort((a,b)=>(a.planEnd||"").localeCompare(b.planEnd||"") || (a.name||"").localeCompare(b.name||""))
          .forEach(it=>{
            rows++;
            const tr = document.createElement("tr");
            tr.addEventListener("click",(e)=>{
              if(e.target.closest("button")) return;
              openModal(it.id);
            });
            tr.innerHTML = `
              <td>${esc(it.number||"‚Äî")}</td>
              <td><b>${esc(it.name||"‚Äî")}</b></td>
              <td>${esc(it.planStart||"‚Äî")}</td>
              <td>${esc(it.planEnd||"‚Äî")}</td>
              <td>${esc(it.owner||"‚Äî")}</td>
              <td>${esc(it.co||"‚Äî")}</td>
              <td>${esc(kpiDisplay(it))}</td>
              <td>${esc(Status[it.status]?.label || it.status)}</td>
              <td>${esc(it.note||"‚Äî")}</td>
              <td>
                <div class="rowActions">
                  <button class="btn small" type="button" onclick="openModal('${it.id}'); event.stopPropagation();">–û—Ç–∫—Ä—ã—Ç—å</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
      });

    }

    function openSectionStats(sec){
      const modal = document.getElementById("sectionStatsModal");
      const items = state.items.filter(it=>it.sectionId===sec.id);
      const counts = {planned:0, work:0, done:0, canceled:0};
      items.forEach(it=>{ counts[it.status] = (counts[it.status]||0)+1; });
      const starts = items.map(it=>it.planStart).filter(Boolean).sort();
      const ends = items.map(it=>it.planEnd).filter(Boolean).sort();
      const moneySum = items.reduce((m,it)=> m + parseMoney(it.money), 0);

      document.getElementById("secStatsTitle").textContent = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–¥–µ–ª–∞";
      document.getElementById("secStatsSub").textContent = sectionDisplayName(sec) || "‚Äî";
      document.getElementById("secStatsTotal").textContent = items.length;
      document.getElementById("secStatsPlanned").textContent = counts.planned||0;
      document.getElementById("secStatsWork").textContent = counts.work||0;
      document.getElementById("secStatsDone").textContent = counts.done||0;
      document.getElementById("secStatsCanceled").textContent = counts.canceled||0;
      document.getElementById("secStatsStart").textContent = starts[0] || "‚Äî";
      document.getElementById("secStatsEnd").textContent = ends[ends.length-1] || "‚Äî";
      document.getElementById("secStatsMoney").textContent = items.length ? formatMoneyWithCurrency(moneySum) : "‚Äî";

      const owners = uniqueList(items.map(it=>(it.owner||"").trim()).filter(Boolean));
      const coExecs = uniqueList(items.flatMap(it=> (it.co||"").split(/[;,]/).map(x=>x.trim()).filter(Boolean)));
      const allExecs = uniqueList([...owners, ...coExecs]);
      const execBox = document.getElementById("secStatsExecs");
      execBox.innerHTML = allExecs.length ? allExecs.map(o=>`<span class="chip">${esc(o)}</span>`).join("") : "‚Äî";

      modal.classList.add("active");
    }

    function closeSectionStats(){
      document.getElementById("sectionStatsModal").classList.remove("active");
    }

    function normalizeSectionOrders(){
      sortedSections().forEach((s,i)=>{ s.order = i+1; s.number = String(i+1); });
      refreshItemNumbers();
    }

    function openSectionEdit(sec){
      editingSectionId = sec.id;
      document.getElementById("secEditTitle").textContent = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞";
      document.getElementById("secEditSub").textContent = sectionDisplayName(sec);
      document.getElementById("secEditNumber").value = sec.number || "";
      document.getElementById("secEditName").value = sec.name || "";
      document.getElementById("secEditDelete").style.display = "inline-flex";
      document.getElementById("secMoveUp").disabled = false;
      document.getElementById("secMoveDown").disabled = false;
      document.getElementById("sectionEditModal").classList.add("active");
    }

    function openSectionCreate(){
      editingSectionId = null;
      const nextOrder = (state.sections.reduce((m,s)=>Math.max(m, s.order||0), 0) || 0) + 1;
      document.getElementById("secEditTitle").textContent = "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞";
      document.getElementById("secEditSub").textContent = "–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª";
      document.getElementById("secEditNumber").value = String(nextOrder);
      document.getElementById("secEditName").value = "";
      document.getElementById("secEditDelete").style.display = "none";
      document.getElementById("secMoveUp").disabled = true;
      document.getElementById("secMoveDown").disabled = true;
      document.getElementById("sectionEditModal").classList.add("active");
    }

    function closeSectionEdit(){
      document.getElementById("sectionEditModal").classList.remove("active");
      editingSectionId = null;
    }

    function saveSectionEdit(){
      const newName = document.getElementById("secEditName").value.trim();
      const newNumber = document.getElementById("secEditNumber").value.trim();
      if(!newName) return;
      if(editingSectionId){
        const sec = byId(state.sections, editingSectionId);
        if(!sec) return;
        sec.name = newName;
        sec.number = newNumber || sec.number || String(sortedSections().findIndex(s=>s.id===sec.id)+1);
      } else {
        const order = (state.sections.reduce((m,s)=>Math.max(m, s.order||0), 0) || 0) + 1;
        state.sections.push({id: uid("sec"), name:newName, number: newNumber || String(order), order, createdAt: nowISO()});
      }
      normalizeSectionOrders();
      save();
      renderAll();
      closeSectionEdit();
    }

    function moveSection(direction){
      const secs = sortedSections();
      const idx = secs.findIndex(s=>s.id===editingSectionId);
      if(idx < 0) return;
      if(direction === "up" && idx>0){
        const prev = secs[idx-1];
        const cur = secs[idx];
        [cur.order, prev.order] = [prev.order, cur.order];
      } else if(direction === "down" && idx < secs.length-1){
        const next = secs[idx+1];
        const cur = secs[idx];
        [cur.order, next.order] = [next.order, cur.order];
      }
      normalizeSectionOrders();
      save();
      renderAll();
      const sec = byId(state.sections, editingSectionId);
      if(sec) document.getElementById("secEditSub").textContent = sectionDisplayName(sec);
    }

    function deleteSectionFromModal(){
      const sec = byId(state.sections, editingSectionId);
      if(!sec) return;
      const count = state.items.filter(it=>it.sectionId===sec.id).length;
      if(count && !confirm("–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–¥–µ–ª –∏ –≤—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è?")) return;
      state.sections = state.sections.filter(s=>s.id!==sec.id);
      state.items = state.items.filter(it=>it.sectionId!==sec.id);
      delete state.collapsedSections[sec.id];
      normalizeSectionOrders();
      save();
      renderAll();
      closeSectionEdit();
    }

    /* =========================
       Kanban (drag & drop)
    ========================= */
    function renderKanban(){
      const board = document.getElementById("kbBoard");
      board.innerHTML = "";

      const groupBy = document.getElementById("kbGroupBy").value;
      const showCanceled = document.getElementById("kbShowCanceled").value === "yes";

      let items = filteredItems();
      if(!showCanceled) items = items.filter(it=>it.status !== "canceled");

      const groups = kanbanGroups(items, groupBy);
      if(!groups.length){
        board.innerHTML = `<div class="note">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>`;
        return;
      }

      groups.forEach(group=>{
        const row = document.createElement("div");
        row.className = "kbRow";
        row.innerHTML = `
          <div class="kbRowHead">
            <div class="kbRowTitle">${esc(group.name)}</div>
            <div class="kbRowMeta">
              <span class="pill"><b>${group.items.length}</b> —à—Ç.</span>
            </div>
          </div>
          <div class="kbRowCols"></div>
        `;

        const colsWrap = row.querySelector(".kbRowCols");

        Columns.forEach(col=>{
          const colItems = group.items.filter(it=>it.status === col.key);
          const colDiv = document.createElement("div");
          colDiv.className = `kbCol ${col.style}`;

          colDiv.innerHTML = `
            <div class=\"kbColHead\">
              <span>${esc(col.label)}</span>
              <span class=\"count\">${colItems.length}</span>
            </div>
            <div class=\"kbColBody\" data-col=\"${col.key}\" data-group=\"${group.key}\">
              <div class=\"dropHint\">–û—Ç–ø—É—Å—Ç–∏—Ç–µ –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞</div>
            </div>
          `;

          const body = colDiv.querySelector(".kbColBody");
          body.addEventListener("dragover", (e)=>{
            if(body.dataset.group && dragGroup && body.dataset.group !== dragGroup) return;
            e.preventDefault();
            body.classList.add("dragOver");
          });
          body.addEventListener("dragleave", ()=> body.classList.remove("dragOver"));
          body.addEventListener("drop", (e)=>{
            e.preventDefault();
            body.classList.remove("dragOver");
            const targetStatus = body.dataset.col;
            if(!dragId) return;
            if(body.dataset.group && dragGroup && body.dataset.group !== dragGroup){
              dragId = null;
              dragGroup = null;
              return;
            }
            moveCardToStatus(dragId, targetStatus);
            dragId = null;
            dragGroup = null;
          });

          colItems.forEach(it=>body.appendChild(kbCardNode(it, group)));
          colsWrap.appendChild(colDiv);
        });

        board.appendChild(row);
      });
    }

    function kanbanGroups(items, groupBy){
      if(groupBy === "section"){
        return sortedSections().map(sec=>({
          key: sec.id,
          name: sectionDisplayName(sec),
          type: "section",
          items: items.filter(it=>it.sectionId===sec.id)
        })).filter(g=>g.items.length);
      }
      if(groupBy === "executor"){
        const map = new Map();
        items.forEach(it=>{
          const owner = (it.owner||"").trim();
          const coExecs = (it.co||"").split(/[;,]/).map(x=>x.trim()).filter(Boolean);
          const execsBase = uniqueList([owner, ...coExecs].filter(Boolean));
          const execs = execsBase.length ? execsBase : ["‚Äî"];
          execs.forEach(exec=>{
            const key = `exec-${exec}`;
            if(!map.has(key)) map.set(key, {key, name: exec, type:"executor", items: []});
            const role = exec === owner || (!owner && exec === "‚Äî") ? "owner" : "co";
            map.get(key).items.push({...it, __role: role});
          });
        });
        return Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name)).filter(g=>g.items.length);
      }
      return [{key:"all", name:"–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", items, type:"all"}];
    }

    function kbCardNode(it, group){
      const card = document.createElement("div");
      card.className = "kbCard";
      card.draggable = true;
      card.dataset.id = it.id;
      card.dataset.group = group?.key || "all";

      card.addEventListener("dragstart", ()=>{
        dragId = it.id;
        dragGroup = card.dataset.group;
        card.classList.add("dragging");
      });
      card.addEventListener("dragend", ()=>{
        dragId = null;
        dragGroup = null;
        card.classList.remove("dragging");
        document.querySelectorAll(".kbColBody.dragOver").forEach(el=>el.classList.remove("dragOver"));
      });
      card.addEventListener("dblclick", ()=> openModal(it.id));
      card.addEventListener("click", (e)=>{
        // single click: open (like Etalon card click)
        // keep drag usable: do not open on dragstart
        if(e.detail === 1){
          // delay to allow drag gesture
          setTimeout(()=>{
            if(!dragId) openModal(it.id);
          }, 120);
        }
      });

      const chips = [];
      if(it.planEnd || it.planStart) chips.push(`<span class="chip muted">${esc(it.planStart||"‚Äî")} ‚Üí ${esc(it.planEnd||"‚Äî")}</span>`);
      const moneyText = moneyDisplay(it.money);
      if(moneyText !== "‚Äî") chips.push(`<span class="chip muted">${esc(moneyText)}</span>`);
      const rep = reportSummary(it);
      if(rep !== "‚Äî") chips.push(`<span class="chip muted">–û—Ç—á–µ—Ç—ã: ${esc(rep)}</span>`);
      if(it.status === "done") chips.push(`<span class="chip ok">–ò—Å–ø–æ–ª–Ω–µ–Ω–æ</span>`);
      if(it.status === "canceled") chips.push(`<span class="chip bad">–û—Ç–º–µ–Ω–µ–Ω–æ</span>`);

      const sectionLine = group?.type !== "section" ? `<div class="kbSectionLine">${esc(sectionDisplayName(byId(state.sections, it.sectionId)) || "‚Äî")}</div>` : "";
      const roleLine = group?.type === "executor" ? `<div class="kbRole">${it.__role === "owner" ? "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" : "–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"}</div>` : "";
      const titleLine = `<div class="kbTitle">${esc([it.number, it.name||"‚Äî"].filter(Boolean).join(" "))}</div>`;
      card.innerHTML = `
        ${sectionLine}
        ${titleLine}
        ${roleLine}
        <div class="kbLine owner">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${esc(it.owner||"‚Äî")}</div>
        <div class="kbLine co">–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${esc(it.co||"‚Äî")}</div>
        <div class="kbMeta">${chips.join("")}</div>
      `;
      return card;
    }

    function moveCardToStatus(itemId, status){
      const it = byId(state.items, itemId);
      if(!it) return;
      it.status = status;
      it.updatedAt = nowISO();
      save();
      renderAll();
    }

    /* =========================
       Gantt (read-only bars, create via plus)
    ========================= */
    function renderGantt(){
      const inner = document.getElementById("gInner");
      inner.innerHTML = "";

      const mode = document.getElementById("gMode").value;
      const showCanceled = document.getElementById("gShowCanceled").value === "yes";
      const year = parseInt((state.dk.year||String(new Date().getFullYear())).trim(), 10) || new Date().getFullYear();

      let items = filteredItems();
      if(!showCanceled) items = items.filter(it=>it.status !== "canceled");

      // Head
      const hL = document.createElement("div");
      hL.className = "gHeadL";
      hL.textContent = "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è";
      const hR = document.createElement("div");
      hR.className = "gHeadR";
      hR.textContent = `–®–∫–∞–ª–∞: ${year} (–º–µ—Å—è—Ü—ã)`;
      inner.appendChild(hL); inner.appendChild(hR);

      // months row
      const l0 = document.createElement("div");
      l0.className = "gLeft";
      l0.innerHTML = `<div class="gRowL"><div class="gName">–†–∞–∑–¥–µ–ª / –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div><div class="gSub">–ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞</div></div>`;
      const r0 = document.createElement("div");
      r0.innerHTML = `<div class="gRowR"><div class="months">${Array.from({length:12},(_,i)=>`<div class="mCell">${mName(i+1)}</div>`).join("")}</div></div>`;
      inner.appendChild(l0); inner.appendChild(r0);

      // by sections
      const secs = sortedSections();
      secs.forEach(sec=>{
        const inSec = items.filter(it=>it.sectionId===sec.id);
        if(!inSec.length) return;

        const lS = document.createElement("div");
        lS.className = "gLeft";
        lS.innerHTML = `<div class="gRowL"><div class="gName">${esc(sectionDisplayName(sec))}</div><div class="gSub"><span class="chip muted">${inSec.length} —à—Ç.</span></div></div>`;
        const rS = document.createElement("div");
        rS.innerHTML = `<div class="gRowR"><div class="barWrap" style="height:10px;background:var(--panel2)"></div></div>`;
        inner.appendChild(lS); inner.appendChild(rS);

        inSec.sort((a,b)=>(a.planStart||"").localeCompare(b.planStart||"") || (a.name||"").localeCompare(b.name||""))
          .forEach(it=>{
            const l = document.createElement("div");
            l.className = "gLeft";
            l.innerHTML = `
              <div class="gRowL">
                <div class="gName">${esc(it.name||"‚Äî")}</div>
                <div class="gSub">
                  <span class="chip">${esc(it.owner||"‚Äî")}</span>
                  <span class="chip muted">${esc((it.planStart||"‚Äî") + " ‚Üí " + (it.planEnd||"‚Äî"))}</span>
                </div>
              </div>
            `;
            l.addEventListener("click", ()=>openModal(it.id));

            const r = document.createElement("div");
            r.className = "gRowR";
            r.innerHTML = ganttBarHTML(it, year, mode);
            r.addEventListener("click", ()=>openModal(it.id));

            inner.appendChild(l);
            inner.appendChild(r);
          });
      });
    }

    function ganttBarHTML(it, year, mode){
      const planS = it.planStart || "";
      const planE = it.planEnd || "";
      let s = planS, e = planE;

      if(mode === "fact"){
        // fact not stored in this version; keep plan behavior (we will extend later)
        s = planS; e = planE;
      }

      if(!s || !e){
        return `<div class="barWrap"><div style="padding:8px 10px; color:var(--muted); font-size:12px">–ù–µ—Ç –¥–∞—Ç</div></div>`;
      }

      const sY = parseInt(s.slice(0,4),10), sM = parseInt(s.slice(5,7),10);
      const eY = parseInt(e.slice(0,4),10), eM = parseInt(e.slice(5,7),10);

      const startMonth = (sY < year) ? 1 : (sY > year ? 13 : sM);
      const endMonth   = (eY > year) ? 12 : (eY < year ? 0 : eM);

      if(startMonth > 12 || endMonth < 1){
        return `<div class="barWrap"><div style="padding:8px 10px; color:var(--muted); font-size:12px">–í–Ω–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ–¥–∞</div></div>`;
      }

      const sm = Math.max(1, Math.min(12, startMonth));
      const em = Math.max(1, Math.min(12, endMonth));
      const leftPct = ((sm-1)/12)*100;
      const widthPct = (Math.max(1,(em-sm+1))/12)*100;

      let cls = "";
      if(it.status === "done") cls = "done";
      else if(it.status === "work") cls = "work";
      else if(it.status === "canceled") cls = "over";

      const label = `${mName(sm)}‚Äì${mName(em)}`;

      return `
        <div class="barWrap">
          <div class="bar ${cls}" style="left:${leftPct}%; width:${widthPct}%;">
            ${esc(label)}
          </div>
        </div>
      `;
    }

    function mName(m){
      const names = ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];
      return names[m-1] || String(m);
    }

    /* =========================
       Modal (create/edit) - single source of truth
    ========================= */
    const modal = document.getElementById("modal");

    function resetReportForm(){
      editingReportId = null;
      const reportDate = document.getElementById("reportDate");
      reportDate.value = "";
      setDefaultDate(reportDate);
      document.getElementById("reportText").value = "";
    }
    function renderReportsUI(){
      const box = document.getElementById("reportsList");
      const toggle = document.getElementById("reportsToggle");
      toggle.style.display = currentReports.length ? "inline-flex" : "none";
      toggle.textContent = reportsCollapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" : "–°–≤–µ—Ä–Ω—É—Ç—å";
      box.innerHTML = "";
      if(!currentReports.length){
        box.textContent = "–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤ –Ω–µ—Ç";
        return;
      }
      if(reportsCollapsed){
        document.getElementById("reportForm").style.display = "none";
        box.textContent = `–ó–∞–ø–∏—Å–µ–π: ${currentReports.length}`;
        return;
      }
      const sorted = [...currentReports].sort((a,b)=>(a.date||"").localeCompare(b.date||""));
      sorted.forEach(rep=>{
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = "space-between";
        row.style.alignItems = "center";
        row.style.gap = "8px";
        row.style.padding = "6px 0";
        row.style.borderBottom = "1px solid var(--border)";
        row.innerHTML = `<div>
          <div style="font-weight:700">${esc(rep.date||"–û—Ç—á–µ—Ç")}</div>
          <div style="font-size:12px">${esc(rep.text||"")}</div>
        </div>
        <div class="btnRow">
              <button class="btn small" type="button" data-action="edit">‚úè</button>
          <button class="btn small danger" type="button" data-action="delete">üóë</button>
        </div>`;
        row.querySelector('[data-action="edit"]').addEventListener("click", ()=>{
          editingReportId = rep.id;
          const reportDate = document.getElementById("reportDate");
          reportDate.value = rep.date || "";
          setDefaultDate(reportDate);
          document.getElementById("reportText").value = rep.text || "";
          document.getElementById("reportForm").style.display = "block";
        });
        row.querySelector('[data-action="delete"]').addEventListener("click", ()=>{
          currentReports = currentReports.filter(r=>r.id!==rep.id);
          renderReportsUI();
        });
        box.appendChild(row);
      });
    }

    function hideReportForm(){
      document.getElementById("reportForm").style.display = "none";
      resetReportForm();
    }

    function saveReportForm(){
      const rep = {
        id: editingReportId || uid("rep"),
        date: document.getElementById("reportDate").value,
        text: document.getElementById("reportText").value.trim(),
      };
      if(editingReportId){
        const idx = currentReports.findIndex(r=>r.id===editingReportId);
        if(idx>=0) currentReports[idx] = rep;
      } else {
        currentReports.push(rep);
      }
      hideReportForm();
      renderReportsUI();
    }

    function resetKpiTargetForm(){
      editingKpiTargetId = null;
      const planDate = document.getElementById("kpiTargetPlanDate");
      planDate.value = "";
      setDefaultDate(planDate);
      document.getElementById("kpiTargetPlanValue").value = "";
      const factDate = document.getElementById("kpiTargetFactDate");
      factDate.value = "";
      setDefaultDate(factDate);
      document.getElementById("kpiTargetFactValue").value = "";
    }
    function hideKpiTargetForm(){
      document.getElementById("kpiTargetForm").style.display = "none";
      resetKpiTargetForm();
    }
    function renderKpiTargetsUI(){
      const box = document.getElementById("kpiTargetsList");
      const toggle = document.getElementById("kpiToggleTargets");
      toggle.style.display = currentKpiTargets.length > 0 ? "inline-flex" : "none";
      toggle.textContent = kpiTargetsCollapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" : "–°–≤–µ—Ä–Ω—É—Ç—å";
      if(!currentKpiTargets.length){
        box.textContent = "–¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã";
        return;
      }
      if(kpiTargetsCollapsed){
        document.getElementById("kpiTargetForm").style.display = "none";
        box.textContent = `–ó–∞–ø–∏—Å–µ–π: ${currentKpiTargets.length}`;
        return;
      }
      box.innerHTML = "";
      const sorted = [...currentKpiTargets].sort((a,b)=> (a.planDate||"").localeCompare(b.planDate||"") || (a.factDate||"").localeCompare(b.factDate||""));
      sorted.forEach(t=>{
        const row = document.createElement("div");
        row.style.display = "grid";
        row.style.gridTemplateColumns = "1fr auto";
        row.style.gap = "8px";
        row.style.alignItems = "center";
        row.style.padding = "6px 0";
        row.style.borderBottom = "1px solid var(--border)";
        row.innerHTML = `<div>
          <div style="font-weight:700">–ü–ª–∞–Ω: ${esc(t.planDate||"–ë–µ–∑ –¥–∞—Ç—ã")}</div>
          <div style="font-size:12px">–ó–Ω–∞—á–µ–Ω–∏–µ: ${esc(t.planValue||"‚Äî")}</div>
          <div style="color:var(--muted); font-size:12px">–§–∞–∫—Ç (${esc(t.factDate||"‚Äî")}): ${esc(t.factValue||"‚Äî")}</div>
        </div>
        <div class="btnRow">
          <button class="btn small" type="button" data-action="edit">‚úè</button>
          <button class="btn small danger" type="button" data-action="delete">üóë</button>
        </div>`;
        row.querySelector('[data-action="edit"]').addEventListener("click", ()=>{
          editingKpiTargetId = t.id;
          const planDate = document.getElementById("kpiTargetPlanDate");
          planDate.value = t.planDate || "";
          setDefaultDate(planDate);
          document.getElementById("kpiTargetPlanValue").value = t.planValue || "";
          const factDate = document.getElementById("kpiTargetFactDate");
          factDate.value = t.factDate || "";
          setDefaultDate(factDate);
          document.getElementById("kpiTargetFactValue").value = t.factValue || "";
          document.getElementById("kpiTargetForm").style.display = "block";
        });
        row.querySelector('[data-action="delete"]').addEventListener("click", ()=>{
          currentKpiTargets = currentKpiTargets.filter(x=>x.id!==t.id);
          renderKpiTargetsUI();
        });
        box.appendChild(row);
      });
    }
    function saveKpiTarget(){
      const t = normalizeKpiTarget({
        id: editingKpiTargetId,
        planDate: document.getElementById("kpiTargetPlanDate").value,
        planValue: document.getElementById("kpiTargetPlanValue").value.trim(),
        factDate: document.getElementById("kpiTargetFactDate").value,
        factValue: document.getElementById("kpiTargetFactValue").value.trim(),
      });
      if(editingKpiTargetId){
        const idx = currentKpiTargets.findIndex(x=>x.id===editingKpiTargetId);
        if(idx>=0) currentKpiTargets[idx] = t;
      }else{
        currentKpiTargets.push(t);
      }
      hideKpiTargetForm();
      renderKpiTargetsUI();
    }

    function renderFinalReportView(){
      const view = document.getElementById("finalReportView");
      if(!currentFinalReport){
        view.textContent = "–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω";
      } else {
        view.innerHTML = [
          `<div style="font-weight:700">${esc(currentFinalReport.period||currentFinalReport.date||"–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç")}</div>`,
          `<div style="color:var(--muted); font-size:12px">${esc(currentFinalReport.date||"–ë–µ–∑ –¥–∞—Ç—ã")}</div>`,
          `<div style="font-size:12px">${esc(currentFinalReport.text||"")}</div>`
        ].join("");
      }
    }

    function planEnded(it){
      if(!it || !it.planEnd) return false;
      const endDate = new Date(it.planEnd);
      const today = new Date();
      endDate.setHours(0,0,0,0);
      today.setHours(0,0,0,0);
      return endDate < today;
    }
    function updateFinalReportAvailability(current){
      const block = document.getElementById("finalReportBlock");
      const allowed = planEnded(current);
      if(block){
        block.classList.toggle("disabledBlock", !allowed);
        block.title = allowed ? "" : "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª–∞";
      }
      ["finalReportEdit","finalReportDelete","finalSave"].forEach(id=>{
        const btn = document.getElementById(id);
        if(btn) btn.disabled = !allowed;
      });
      if(!allowed) closeFinalForm();
    }

    function openFinalForm(){
      const finalDate = document.getElementById("finalDate");
      finalDate.value = currentFinalReport?.date || "";
      setDefaultDate(finalDate);
      document.getElementById("finalPeriod").value = currentFinalReport?.period || "";
      document.getElementById("finalText").value = currentFinalReport?.text || "";
      document.getElementById("finalReportForm").style.display = "block";
    }

    function closeFinalForm(){
      document.getElementById("finalReportForm").style.display = "none";
    }

    function saveFinalReport(){
      currentFinalReport = {
        id: currentFinalReport?.id || uid("rep"),
        date: document.getElementById("finalDate").value,
        period: document.getElementById("finalPeriod").value.trim(),
        text: document.getElementById("finalText").value.trim(),
      };
      renderFinalReportView();
      closeFinalForm();
    }

    function deleteFinalReport(){
      currentFinalReport = null;
      renderFinalReportView();
      closeFinalForm();
    }

    function openModal(id, opts={}){
      renderFilters(); // ensure section list up-to-date
      const isNew = !id;
      let it = isNew ? null : byId(state.items, id);
      if(!it && !isNew) return;

      if(isNew){
        const secId = opts.sectionId || sortedSections()[0]?.id || null;
        it = {
          id: uid("it"),
          name:"",
          sectionId: secId,
          status:"planned",
          planStart:todayDate(),
          planEnd:todayDate(),
          owner:"",
          co:"",
          money:"",
          result:"",
          note:"",
          number:"",
          reports:[],
          finalReport:null,
          kpi:{name:"", unit:""},
          createdAt: nowISO(),
          updatedAt: nowISO()
        };
        // not yet saved; keep in temp
        editingId = it.id;
        tempNewItem = it;
      }else{
        editingId = id;
        tempNewItem = null;
      }

      const current = tempNewItem || it;

      document.getElementById("mTitle").textContent = isNew ? "–°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" : "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏";
      document.getElementById("mSub").textContent = current.name ? current.name : "‚Äî";
      document.getElementById("mId").textContent = current.id;

      document.getElementById("mStatus").value = current.status;
      document.getElementById("mSection").value = current.sectionId || "";
      const mPlanStart = document.getElementById("mPlanStart");
      const mPlanEnd = document.getElementById("mPlanEnd");
      mPlanStart.value = current.planStart || "";
      mPlanEnd.value = current.planEnd || "";
      setDefaultDate(mPlanStart);
      setDefaultDate(mPlanEnd);
      document.getElementById("mOwner").value = current.owner || "";
      document.getElementById("mCo").value = current.co || "";
      document.getElementById("mMoney").value = current.money || "";
      document.getElementById("mNumber").value = current.number || "";
      document.getElementById("mKpiName").value = current.kpi?.name || "";
      document.getElementById("mKpiUnit").value = current.kpi?.unit || "";

      document.getElementById("mName").value = current.name || "";
      document.getElementById("mResult").value = current.result || "";
      document.getElementById("mNote").value = current.note || "";

      document.getElementById("mCreated").textContent = current.createdAt || "‚Äî";
      document.getElementById("mUpdated").textContent = current.updatedAt || "‚Äî";

      currentReports = (current.reports||[]).map(r=>({...r}));
      currentKpiTargets = (current.kpiTargets||[]).map(t=>({...t}));
      currentFinalReport = current.finalReport ? {...current.finalReport} : null;
      hideReportForm();
      closeFinalForm();
      renderReportsUI();
      hideKpiTargetForm();
      kpiTargetsCollapsed = false;
      reportsCollapsed = false;
      renderKpiTargetsUI();
      renderFinalReportView();

      updateFinalReportAvailability(current);

      // Delete button disabled for new unsaved
      document.getElementById("mDelete").disabled = !!tempNewItem;

      modal.classList.add("active");
    }

    function closeModal(){
      modal.classList.remove("active");
      editingId = null;
      tempNewItem = null;
      currentReports = [];
      currentKpiTargets = [];
      currentFinalReport = null;
      editingReportId = null;
      editingKpiTargetId = null;
      kpiTargetsCollapsed = false;
      reportsCollapsed = false;
    }

    let tempNewItem = null;

    function collectModal(){
      return {
        status: document.getElementById("mStatus").value,
        sectionId: document.getElementById("mSection").value,
        planStart: document.getElementById("mPlanStart").value,
        planEnd: document.getElementById("mPlanEnd").value,
        owner: document.getElementById("mOwner").value.trim(),
        co: document.getElementById("mCo").value.trim(),
        money: document.getElementById("mMoney").value.trim(),
        number: document.getElementById("mNumber").value.trim(),
        name: document.getElementById("mName").value.trim(),
        result: document.getElementById("mResult").value.trim(),
        note: document.getElementById("mNote").value.trim(),
        kpi: {
          name: document.getElementById("mKpiName").value.trim(),
          unit: document.getElementById("mKpiUnit").value.trim(),
        },
        reports: currentReports.map(r=>({...r})),
        kpiTargets: currentKpiTargets.map(t=>({...t})),
        finalReport: currentFinalReport ? {...currentFinalReport} : null,
      };
    }

    function saveModal(){
      const data = collectModal();

      if(tempNewItem){
        Object.assign(tempNewItem, data);
        tempNewItem.updatedAt = nowISO();
        if(!tempNewItem.number){
          tempNewItem.number = autoNumberForItem(tempNewItem.sectionId);
        }
        if(!tempNewItem.name){
          alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ¬´–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ¬ª.");
          return;
        }
        if(!tempNewItem.sectionId){
          alert("–í—ã–±–µ—Ä–∏—Ç–µ ¬´–†–∞–∑–¥–µ–ª¬ª.");
          return;
        }
        state.items.push(tempNewItem);
        tempNewItem = null;
      } else {
        const it = byId(state.items, editingId);
        if(!it) return;
        Object.assign(it, data);
        if(!it.number){
          it.number = autoNumberForItem(it.sectionId, it.id);
        }
        it.updatedAt = nowISO();
        if(!it.name){
          alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ¬´–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ¬ª.");
          return;
        }
      }

      save();
      renderAll();
      closeModal();
    }

    function deleteModal(){
      if(tempNewItem) return;
      const it = byId(state.items, editingId);
      if(!it) return;
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É?")) return;
      state.items = state.items.filter(x=>x.id !== it.id);
      save();
      renderAll();
      closeModal();
    }

    /* =========================
       Tabs
    ========================= */
    function setTab(tab){
      currentTab = tab;
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === tab);
      });
      document.getElementById("viewTable").style.display = (tab==="table") ? "block" : "none";
      document.getElementById("viewKanban").style.display = (tab==="kanban") ? "block" : "none";
      document.getElementById("viewGantt").style.display = (tab==="gantt") ? "block" : "none";
      document.getElementById("panelTitle").textContent =
        tab==="table" ? "–¢–∞–±–ª–∏—Ü–∞" : (tab==="kanban" ? "–î–æ—Å–∫–∏" : "–ì–∞–Ω—Ç");
      renderAll();
    }

    /* =========================
       Export / Import
    ========================= */
    function exportJSON(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "roadmap_etalon_reference.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importJSON(file){
      file.text().then(text=>{
        const obj = JSON.parse(text);
        if(!obj || !obj.dk || !Array.isArray(obj.sections) || !Array.isArray(obj.items)) throw new Error("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞");
        state = obj;
        ensureDefaults();
        save();
        renderAll();
        alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω.");
      }).catch(err=>{
        alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + err.message);
      });
    }

    /* =========================
       Render all
    ========================= */
    function renderAll(){
      ensureDefaults();
      // DK
      setDKMini();

      renderFilters();
      renderKPI();

      if(currentTab === "table") renderTable();
      if(currentTab === "kanban") renderKanban();
      if(currentTab === "gantt") renderGantt();
    }

    /* =========================
       Event wiring
    ========================= */
    // Tabs
    document.querySelectorAll(".tab").forEach(b=>{
      b.addEventListener("click", ()=> setTab(b.dataset.tab));
    });

    // Global search
    document.getElementById("globalSearch").addEventListener("input", ()=>renderAll());

    // Filters
    ["fStatus","fSection","fExec"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>renderAll());
      document.getElementById(id).addEventListener("change", ()=>renderAll());
    });

    // DK fields
    document.getElementById("dkName").addEventListener("input", (e)=>{
      state.dk.name = e.target.value;
      save();
      renderAll();
    });
    document.getElementById("dkPeriodStart").addEventListener("input", (e)=>{
      state.dk.periodStart = e.target.value;
      if(!state.dk.year && e.target.value) state.dk.year = e.target.value.slice(0,4);
      save();
      renderAll();
    });
    document.getElementById("dkPeriodEnd").addEventListener("input", (e)=>{
      state.dk.periodEnd = e.target.value;
      save();
      renderAll();
    });
    document.getElementById("dkOwner").addEventListener("input", (e)=>{
      state.dk.owner = e.target.value;
      save();
      renderAll();
    });
    document.getElementById("dkApprovedBy").addEventListener("input", (e)=>{
      state.dk.approvedBy = e.target.value;
      save();
      renderAll();
    });
    document.getElementById("dkApprovedDoc").addEventListener("input", (e)=>{
      state.dk.approvedDoc = e.target.value;
      save();
      renderAll();
    });

    // Add section
    document.getElementById("btnAddSection").addEventListener("click", ()=>{
      openSectionCreate();
    });

    // Add item (sidebar) -> open modal NEW
    document.getElementById("btnAddItem").addEventListener("click", ()=>{
      if(state.sections.length === 0){
        alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–¥–µ–ª.");
        return;
      }
      openModal(null);
    });

    // Kanban plus
    document.getElementById("kbPlus").addEventListener("click", ()=>{
      if(state.sections.length === 0){
        alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–¥–µ–ª.");
        return;
      }
      openModal(null);
    });

    // Gantt plus
    document.getElementById("gPlus").addEventListener("click", ()=>{
      if(state.sections.length === 0){
        alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ä–∞–∑–¥–µ–ª.");
        return;
      }
      openModal(null);
    });

    // Kanban controls
    ["kbGroupBy","kbShowCanceled"].forEach(id=>{
      document.getElementById(id).addEventListener("change", ()=>renderAll());
    });

    // Gantt controls
    ["gMode","gShowCanceled"].forEach(id=>{
      document.getElementById(id).addEventListener("change", ()=>renderAll());
    });

    // Modal controls
    document.getElementById("mClose").addEventListener("click", closeModal);
    document.getElementById("mCancel").addEventListener("click", closeModal);
    document.getElementById("mSave").addEventListener("click", saveModal);
    document.getElementById("mDelete").addEventListener("click", deleteModal);
    document.getElementById("mPlanEnd").addEventListener("input", ()=>updateFinalReportAvailability(collectModal()));
    document.getElementById("addReportBtn").addEventListener("click", ()=>{
      resetReportForm();
      document.getElementById("reportForm").style.display = "block";
    });
    document.getElementById("reportSave").addEventListener("click", saveReportForm);
    document.getElementById("reportCancel").addEventListener("click", hideReportForm);
    document.getElementById("reportsToggle").addEventListener("click", ()=>{
      reportsCollapsed = !reportsCollapsed;
      renderReportsUI();
    });
    document.getElementById("kpiAddTarget").addEventListener("click", ()=>{
      resetKpiTargetForm();
      document.getElementById("kpiTargetForm").style.display = "block";
    });
    document.getElementById("kpiTargetSave").addEventListener("click", saveKpiTarget);
    document.getElementById("kpiTargetCancel").addEventListener("click", hideKpiTargetForm);
    document.getElementById("kpiToggleTargets").addEventListener("click", ()=>{
      kpiTargetsCollapsed = !kpiTargetsCollapsed;
      renderKpiTargetsUI();
    });
    document.getElementById("finalReportEdit").addEventListener("click", openFinalForm);
    document.getElementById("finalReportDelete").addEventListener("click", deleteFinalReport);
    document.getElementById("finalSave").addEventListener("click", saveFinalReport);
    document.getElementById("finalCancel").addEventListener("click", closeFinalForm);
    ["secStatsClose"].forEach(id=>{
      document.getElementById(id).addEventListener("click", closeSectionStats);
    });
    document.getElementById("secEditClose").addEventListener("click", closeSectionEdit);
    document.getElementById("secEditCancel").addEventListener("click", closeSectionEdit);
    document.getElementById("secEditSave").addEventListener("click", saveSectionEdit);
    document.getElementById("secEditDelete").addEventListener("click", deleteSectionFromModal);
    document.getElementById("secMoveUp").addEventListener("click", ()=>moveSection("up"));
    document.getElementById("secMoveDown").addEventListener("click", ()=>moveSection("down"));

    // Demo / clear / export / import
    document.getElementById("btnDemo").addEventListener("click", ()=>{
      if(!confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.")) return;
      state = demo();
      save();
      renderAll();
    });

    document.getElementById("btnClear").addEventListener("click", ()=>{
      if(!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) return;
      state = { dk:{name:"–î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞", year:String(new Date().getFullYear()), periodStart:"", periodEnd:"", owner:"", approvedBy:"", approvedDoc:""}, sections:[], items:[], collapsedSections:{} };
      ensureDefaults();
      localStorage.removeItem(STORAGE_KEY);
      save();
      renderAll();
    });

    document.getElementById("btnExport").addEventListener("click", exportJSON);
    document.getElementById("btnImport").addEventListener("click", ()=>{
      document.getElementById("importFile").click();
    });
    document.getElementById("importFile").addEventListener("change", (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      importJSON(f);
      e.target.value = "";
    });

    // Expose for inline
    window.openModal = openModal;

    // Init
    setTab("table");
    renderAll();
  </script>
</body>
</html>
